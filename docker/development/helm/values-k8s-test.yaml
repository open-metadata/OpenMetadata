# Test values for K8s native pipeline client validation
# Only contains essential overrides for testing

openmetadata:
  config:
    # Enable debug logging for testing
    logLevel: DEBUG
    
    # Database configuration (using local PostgreSQL via host machine)
    database:
      host: host.docker.internal
      port: 5433
      driverClass: org.postgresql.Driver
      dbScheme: postgresql
      auth:
        password:
          secretRef: postgres-secrets
          secretKey: openmetadata-postgres-password
    
    # Search configuration (using local OpenSearch via host machine)
    elasticsearch:
      host: host.docker.internal
      port: 9200
      searchType: opensearch
      scheme: http
    
    # K8s Pipeline Client Configuration - This is what we're testing!
    pipelineServiceClientConfig:
      type: "k8s"  # Use Kubernetes native instead of Airflow
      k8s:
        # Override metadataApiEndpoint for cross-namespace access (default uses service name only)
        metadataApiEndpoint: "http://openmetadata.openmetadata-ingestion.svc.cluster.local:8585/api"
        # Test namespace
        namespace: "openmetadata-pipelines-test"
        serviceAccountName: "openmetadata-ingestion-test"
        
        # Local ingestion image
        ingestionImage: "openmetadata/ingestion-base:20260109"
        imagePullPolicy: "IfNotPresent"
        
        # Reduced resources for local testing
        resources:
          limits:
            cpu: "1"
            memory: "2Gi"
          requests:
            cpu: "100m"
            memory: "512Mi"

        # Testing environment variables
        extraEnvVars:
          - "LOG_LEVEL:DEBUG"
          - "PYTHONDONTWRITEBYTECODE:1"
        
        # Enable OMJob operator for guaranteed exit handler execution
        useOMJobOperator: true

# Local image configuration
image:
  repository: openmetadata/server
  tag: "20260108-19"
  pullPolicy: IfNotPresent

# Service configuration for local access
service:
  type: LoadBalancer  # For minikube tunnel access

# OMJob Operator configuration
omjobOperator:
  enabled: true
  # Use locally built image
  image:
    repository: docker.getcollate.io/openmetadata/omjob-operator
    tag: "1.12.0-SNAPSHOT"
    pullPolicy: IfNotPresent
  # Adjusted resources for Java application (was OOMKilled at 128Mi)
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "1Gi"
  # Debug logging for testing
  env:
    logLevel: "DEBUG"
    watchNamespaces: "openmetadata-pipelines-test"
  # Enable health checks now that operator implements proper endpoints
  healthCheck:
    enabled: true

# Reduced resources for local testing
resources:
  limits:
    cpu: 2
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# More relaxed health checks for local testing
livenessProbe:
  initialDelaySeconds: 120
readinessProbe:
  initialDelaySeconds: 120
startupProbe:
  failureThreshold: 10