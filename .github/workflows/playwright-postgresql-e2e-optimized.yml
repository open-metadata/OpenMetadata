name: Postgresql PR Playwright E2E Tests (Optimized)

on:
  workflow_dispatch:
  pull_request:
    paths-ignore:
      - '.github/**'
      - 'openmetadata-dist/**'
      - 'docker/**'
      - '!docker/development/docker-compose.yml'
      - '!docker/development/docker-compose-postgres.yml'

permissions:
  contents: read

concurrency:
  group: playwright-ci-pr-postgresql-optimized-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------------------------------
  # JOB 1: BUILD ARTIFACTS
  # This job compiles the server and generates python models once.
  # ------------------------------------------------------------------------------------------
  build-artifacts:
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    environment: test
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          swap-storage: true
          docker-images: false

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      # Build the Server (Skipping Tests) - This creates openmetadata-dist/target/openmetadata-*.tar.gz
      - name: Maven Build (Skip Tests)
        run: mvn -DskipTests clean package -pl openmetadata-dist -am

      # Generate Python Models - Required for Ingestion
      - name: Install ANTLR & Generate Models
        run: |
          sudo make install_antlr_cli
          python3 -m venv env
          source env/bin/activate
          make install_dev generate

      - name: Upload Server Artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-dist
          path: openmetadata-dist/target
          retention-days: 1

      - name: Upload Generated Models
        uses: actions/upload-artifact@v4
        with:
          name: generated-models
          path: ingestion/src/metadata/generated
          retention-days: 1

  # ------------------------------------------------------------------------------------------
  # JOB 2: RUN TESTS (SHARDS)
  # This job downloads the artifacts and runs the tests in parallel.
  # ------------------------------------------------------------------------------------------
  playwright-ci-postgresql:
    needs: build-artifacts
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    environment: test
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4, 5, 6]
        shardTotal: [6]
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          swap-storage: true
          docker-images: false

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # Download the pre-built Server
      - name: Download Server Artifact
        uses: actions/download-artifact@v4
        with:
          name: server-dist
          path: openmetadata-dist/target

      # Download the pre-generated Models
      - name: Download Generated Models
        uses: actions/download-artifact@v4
        with:
          name: generated-models
          path: ingestion/src/metadata/generated

      - name: Setup Openmetadata Test Environment (Skip Build)
        uses: ./.github/actions/setup-openmetadata-test-environment
        with:
          python-version: "3.10"
          # -s true tells the script to SKIP the Maven Build
          args: "-d postgresql -s true"
          ingestion_dependency: "all"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'openmetadata-ui/src/main/resources/ui/.nvmrc'
          cache: 'yarn'
          cache-dependency-path: 'openmetadata-ui/src/main/resources/ui/yarn.lock'

      - name: Install dependencies
        working-directory: openmetadata-ui/src/main/resources/ui/
        run: yarn --ignore-scripts --frozen-lockfile

      - name: Install Playwright Browsers
        run: npx playwright@1.51.1 install --with-deps

      - name: Run Playwright tests
        working-directory: openmetadata-ui/src/main/resources/ui/
        run: |
          if [ "${{ matrix.shardIndex }}" -eq "1" ]; then
            echo "ðŸ”¹ Running ISOLATED tests (DataAssetRules) on Shard 1"
            # Since we skipped the build, this shard starts fast.
            # Running both Enabled and Disabled sequentially ensures isolation.
            
            npx playwright test \
              --project=setup \
              --project=DataAssetRulesEnabled \
              --project=DataAssetRulesDisabled \
              --workers=80%

          else
            # Shards 2-6 handle the heavy chromium tests (Split 5 ways)
            TOTAL_WORKERS=5
            CHROMIUM_SHARD=$(( ${{ matrix.shardIndex }} - 1 )) # 1 to 5
            
            if [[ "${{ contains(github.event.pull_request.changed_files, 'ingestion/') }}" == "true" ]]; then
              echo "ðŸ”¹ Running ingestion tests on chromium shard ${CHROMIUM_SHARD}/5"
              npx playwright test \
                --project=chromium \
                --grep @ingestion \
                --grep-invert @dataAssetRules \
                --shard=${CHROMIUM_SHARD}/5 \
                --workers=80%

            else
              echo "ðŸ”¹ Running all other tests (excluding DataAssetRules) on chromium shard ${CHROMIUM_SHARD}/5"
              npx playwright test \
                --project=chromium \
                --grep-invert @dataAssetRules \
                --shard=${CHROMIUM_SHARD}/5 \
                --workers=80%
            fi
          fi

        env:
          PLAYWRIGHT_IS_OSS: true
          PLAYWRIGHT_SNOWFLAKE_USERNAME: ${{ secrets.TEST_SNOWFLAKE_USERNAME }}
          PLAYWRIGHT_SNOWFLAKE_PASSWORD: ${{ secrets.TEST_SNOWFLAKE_PASSWORD }}
          PLAYWRIGHT_SNOWFLAKE_ACCOUNT: ${{ secrets.TEST_SNOWFLAKE_ACCOUNT }}
          PLAYWRIGHT_SNOWFLAKE_DATABASE: ${{ secrets.TEST_SNOWFLAKE_DATABASE }}
          PLAYWRIGHT_SNOWFLAKE_WAREHOUSE: ${{ secrets.TEST_SNOWFLAKE_WAREHOUSE }}
          PLAYWRIGHT_SNOWFLAKE_PASSPHRASE: ${{ secrets.TEST_SNOWFLAKE_PASSPHRASE }}
          PLAYWRIGHT_PROJECT_ID: ${{ steps.cypress-project-id.outputs.CYPRESS_PROJECT_ID }}
          PLAYWRIGHT_BQ_PRIVATE_KEY: ${{ secrets.TEST_BQ_PRIVATE_KEY }}
          PLAYWRIGHT_BQ_PROJECT_ID: ${{ secrets.TEST_BQ_PROJECT_ID }}
          PLAYWRIGHT_BQ_PRIVATE_KEY_ID: ${{ secrets.TEST_BQ_PRIVATE_KEY_ID }}
          PLAYWRIGHT_BQ_PROJECT_ID_TAXONOMY: ${{ secrets.TEST_BQ_PROJECT_ID_TAXONOMY }}
          PLAYWRIGHT_BQ_CLIENT_EMAIL: ${{ secrets.TEST_BQ_CLIENT_EMAIL }}
          PLAYWRIGHT_BQ_CLIENT_ID: ${{ secrets.TEST_BQ_CLIENT_ID }}
          PLAYWRIGHT_REDSHIFT_HOST: ${{ secrets.E2E_REDSHIFT_HOST_PORT }}
          PLAYWRIGHT_REDSHIFT_USERNAME: ${{ secrets.E2E_REDSHIFT_USERNAME }}
          PLAYWRIGHT_REDSHIFT_PASSWORD: ${{ secrets.E2E_REDSHIFT_PASSWORD }}
          PLAYWRIGHT_REDSHIFT_DATABASE: ${{ secrets.TEST_REDSHIFT_DATABASE }}
          PLAYWRIGHT_METABASE_USERNAME: ${{ secrets.TEST_METABASE_USERNAME }}
          PLAYWRIGHT_METABASE_PASSWORD: ${{ secrets.TEST_METABASE_PASSWORD }}
          PLAYWRIGHT_METABASE_DB_SERVICE_NAME: ${{ secrets.TEST_METABASE_DB_SERVICE_NAME }}
          PLAYWRIGHT_METABASE_HOST_PORT: ${{ secrets.TEST_METABASE_HOST_PORT }}
          PLAYWRIGHT_SUPERSET_USERNAME: ${{ secrets.TEST_SUPERSET_USERNAME }}
          PLAYWRIGHT_SUPERSET_PASSWORD: ${{ secrets.TEST_SUPERSET_PASSWORD }}
          PLAYWRIGHT_SUPERSET_HOST_PORT: ${{ secrets.TEST_SUPERSET_HOST_PORT }}
          PLAYWRIGHT_KAFKA_BOOTSTRAP_SERVERS: ${{ secrets.TEST_KAFKA_BOOTSTRAP_SERVERS }}
          PLAYWRIGHT_KAFKA_SCHEMA_REGISTRY_URL: ${{ secrets.TEST_KAFKA_SCHEMA_REGISTRY_URL }}
          PLAYWRIGHT_GLUE_ACCESS_KEY: ${{ secrets.TEST_GLUE_ACCESS_KEY }}
          PLAYWRIGHT_GLUE_SECRET_KEY: ${{ secrets.TEST_GLUE_SECRET_KEY }}
          PLAYWRIGHT_GLUE_AWS_REGION: ${{ secrets.TEST_GLUE_AWS_REGION }}
          PLAYWRIGHT_GLUE_ENDPOINT: ${{ secrets.TEST_GLUE_ENDPOINT }}
          PLAYWRIGHT_GLUE_STORAGE_SERVICE: ${{ secrets.TEST_GLUE_STORAGE_SERVICE }}
          PLAYWRIGHT_MYSQL_USERNAME: ${{ secrets.TEST_MYSQL_USERNAME }}
          PLAYWRIGHT_MYSQL_PASSWORD: ${{ secrets.TEST_MYSQL_PASSWORD }}
          PLAYWRIGHT_MYSQL_HOST_PORT: ${{ secrets.TEST_MYSQL_HOST_PORT }}
          PLAYWRIGHT_MYSQL_DATABASE_SCHEMA: ${{ secrets.TEST_MYSQL_DATABASE_SCHEMA }}
          PLAYWRIGHT_POSTGRES_USERNAME: ${{ secrets.TEST_POSTGRES_USERNAME }}
          PLAYWRIGHT_POSTGRES_PASSWORD: ${{ secrets.TEST_POSTGRES_PASSWORD }}
          PLAYWRIGHT_POSTGRES_HOST_PORT: ${{ secrets.TEST_POSTGRES_HOST_PORT }}
          PLAYWRIGHT_POSTGRES_DATABASE: ${{ secrets.TEST_POSTGRES_DATABASE }}
          PLAYWRIGHT_AIRFLOW_HOST_PORT: ${{ secrets.TEST_AIRFLOW_HOST_PORT }}
          PLAYWRIGHT_ML_MODEL_TRACKING_URI: ${{ secrets.TEST_ML_MODEL_TRACKING_URI }}
          PLAYWRIGHT_ML_MODEL_REGISTRY_URI: ${{ secrets.TEST_ML_MODEL_REGISTRY_URI }}
          PLAYWRIGHT_S3_STORAGE_ACCESS_KEY_ID: ${{ secrets.TEST_S3_STORAGE_ACCESS_KEY_ID }}
          PLAYWRIGHT_S3_STORAGE_SECRET_ACCESS_KEY: ${{ secrets.TEST_S3_STORAGE_SECRET_ACCESS_KEY }}
          PLAYWRIGHT_S3_STORAGE_END_POINT_URL: ${{ secrets.TEST_S3_STORAGE_END_POINT_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-optimized-${{ matrix.shardIndex }}
          path: openmetadata-ui/src/main/resources/ui/playwright/output/playwright-report
          retention-days: 5

      - name: Clean Up
        run: |
          cd ./docker/development
          docker compose down --remove-orphans
          sudo rm -rf ${PWD}/docker-volume
