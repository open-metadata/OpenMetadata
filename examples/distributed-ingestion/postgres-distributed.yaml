# PostgreSQL Distributed Ingestion Example
# This example shows how to ingest a PostgreSQL database with distributed execution.

source:
  type: postgres
  serviceName: postgres-prod
  serviceConnection:
    config:
      type: Postgres
      username: ${POSTGRES_USER}
      password: ${POSTGRES_PASSWORD}
      hostPort: ${POSTGRES_HOST}:${POSTGRES_PORT:-5432}
      database: ${POSTGRES_DATABASE}
  sourceConfig:
    config:
      type: DatabaseMetadata
      schemaFilterPattern:
        includes:
          - "^public$"
          - "^analytics$"
      tableFilterPattern: {}
      includeViews: true
      includeTables: true
      includeStoredProcedures: true
      markDeletedTables: true

sink:
  type: metadata-rest
  config:
    api_endpoint: null

workflowConfig:
  openMetadataServerConfig:
    hostPort: ${OPENMETADATA_HOST_PORT:-http://localhost:8585/api}
    authProvider: openmetadata
    securityConfig:
      jwtToken: ${OM_JWT_TOKEN}

  # Distributed Execution Configuration
  distributedExecution:
    enabled: true
    orchestrator: argo
    parallelism: 30  # Process 30 tables in parallel
    namespace: default
    image: openmetadata/ingestion:latest

    retryPolicy:
      maxAttempts: 3
      backoffSeconds: 30
      backoffFactor: 2
      maxBackoffSeconds: 300

    resourceRequests:
      cpu: "500m"
      memory: "1Gi"

    resourceLimits:
      cpu: "1"
      memory: "2Gi"

    waitForCompletion: true  # Wait for completion
    timeoutSeconds: 3600  # 1 hour

  loggerLevel: INFO
  raiseOnError: false
  successThreshold: 95
